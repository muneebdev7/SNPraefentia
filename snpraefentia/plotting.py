"""Plotting module for SNPraefentia.

This module provides functions to generate various plots for visualizing the output CSV generated by SNPraefentia.
"""

import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns
import numpy as np
from adjustText import adjust_text
from matplotlib.lines import Line2D
from mpl_toolkits.axes_grid1 import make_axes_locatable
import os

def plot_boxplot(input_csv, output_dir):
    """Generate a boxplot for Normalized Depth and Amino Acid Impact Scores.

    Args:
        input_csv (str): Path to the input CSV file.
        output_dir (str): Directory to save the output plots.
    """
    ext = os.path.splitext(input_csv)[1].lower()
    if ext in [".xlsx", ".xls"]:
        df = pd.read_excel(input_csv)
    else:
        df = pd.read_csv(input_csv)
    required_cols = ["Normalized_Depth", "Amino_Acid_Impact_Score"]
    for col in required_cols:
        if col not in df.columns:
            raise ValueError(f"Column '{col}' not found in input file for boxplot.")
    data = df[required_cols]
    data_melted = data.melt(var_name="Feature", value_name="Value")

    max_val = data_melted["Value"].max()
    ytick_max = np.ceil(max_val + 0.5)
    yticks = np.arange(0, ytick_max + 0.5, 0.5)
    ymin = -0.2 if data_melted["Value"].min() >= 0 else data_melted["Value"].min() - 0.2

    plt.figure(figsize=(8, 6))
    sns.set(style="whitegrid", context="talk", font="DejaVu Sans")

    ax = sns.boxplot(
        x="Feature", y="Value", data=data_melted,
        hue="Feature",
        palette={"Normalized_Depth": "#66c2a5", "Amino_Acid_Impact_Score": "#fc8d62"},
        width=0.5, linewidth=1.5, showmeans=False,
        meanprops={"marker": "o", "markerfacecolor": "black", "markeredgecolor": "black", "markersize": 6},
        legend=False
    )

    plt.title("Distribution of Normalized Depth and Amino Acid Impact Scores",
                fontsize=12, fontweight="bold")
    plt.ylabel("Feature Value", fontsize=14, fontstyle="italic")
    plt.xlabel("Feature Type", fontsize=14, fontstyle="italic")
    plt.ylim(ymin, ytick_max)
    plt.yticks(yticks, fontsize=10)
    plt.xticks(fontsize=12)
    plt.grid(axis='y', linestyle='--', alpha=0.3)

    for spine in ax.spines.values():
        spine.set_edgecolor('black')
        spine.set_linewidth(0.8)

    plt.tight_layout()

    # Ensure output directory exists
    os.makedirs(output_dir, exist_ok=True)

    # Save plots in PNG and PDF formats
    plt.savefig(os.path.join(output_dir, "boxplot_distribution.png"), dpi=1200, bbox_inches='tight')
    plt.savefig(os.path.join(output_dir, "boxplot_distribution.pdf"), bbox_inches='tight')
    plt.close()

def plot_pie_chart(input_csv, output_dir):
    """Generate a pie chart for domain position match distribution.

    Args:
        input_csv (str): Path to the input CSV file.
        output_dir (str): Directory to save the output plots.
    """
    ext = os.path.splitext(input_csv)[1].lower()
    if ext in [".xlsx", ".xls"]:
        df = pd.read_excel(input_csv)
    else:
        df = pd.read_csv(input_csv)
    if 'Domain_Position_Match' not in df.columns:
        raise ValueError("Column 'Domain_Position_Match' not found in input file for pie chart.")
    domain_counts = df['Domain_Position_Match'].value_counts()
    counts = [domain_counts.get(1, 0), domain_counts.get(0, 0)]
    total = sum(counts)
    percentages = [count / total * 100 if total > 0 else 0 for count in counts]
    labels_inside = [f"{count}\n({p:.1f}%)" for count, p in zip(counts, percentages)]

    fig, ax = plt.subplots(figsize=(7, 6.5))
    colors = ['#66c2a5', '#fc8d62']

    wedges, _ = ax.pie(
        counts,
        colors=colors,
        startangle=90,
        labels=labels_inside,
        labeldistance=0.45,
        textprops={'fontsize': 11, 'color': 'black'},
        wedgeprops={'edgecolor': 'white', 'linewidth': 1.3}
    )

    # Add outlined legend box in top-right corner
    legend_labels = ['Within Domain', 'Outside Domain']
    legend = ax.legend(
        wedges,
        legend_labels,
        loc='upper right',
        bbox_to_anchor=(1.04, 1.04),
        fontsize=11,
        title="Domain Info",
        title_fontsize=12,
        frameon=True
    )
    legend.get_frame().set_edgecolor('black')
    legend.get_frame().set_linewidth(0.8)

    plt.tight_layout()

    ax.set_title(
        "Distribution of Variants Across Protein Domains",
        fontsize=12,
        weight="bold",
        pad=25,
        loc='center'
    )

    plt.tight_layout()

    # Ensure output directory exists
    os.makedirs(output_dir, exist_ok=True)

    # Save plots in PNG and PDF formats
    fig.savefig(os.path.join(output_dir, "domain_pie_chart.png"), dpi=1200, bbox_inches='tight')
    fig.savefig(os.path.join(output_dir, "domain_pie_chart.pdf"), bbox_inches='tight')
    plt.close()

def plot_histogram(input_csv, output_dir):
    """Generate a histogram for Final Priority Scores.

    Args:
        input_csv (str): Path to the input CSV file.
        output_dir (str): Directory to save the output plots.
    """
    ext = os.path.splitext(input_csv)[1].lower()
    if ext in [".xlsx", ".xls"]:
        df = pd.read_excel(input_csv)
    else:
        df = pd.read_csv(input_csv)
    if 'Final_Priority_Score' not in df.columns:
        raise ValueError("Column 'Final_Priority_Score' not found in input file for histogram.")
    scores = df['Final_Priority_Score'].dropna()

    fig, ax = plt.subplots(figsize=(7, 5))
    colors = ['#66c2a5', '#fc8d62']

    ax.hist(
        scores,
        bins=20,
        color=colors[0],
        edgecolor='black',
        alpha=0.9,
        linewidth=0.8
    )

    ax.set_xlabel('Final Priority Score', fontsize=12, style='italic', labelpad=10)
    ax.set_ylabel('Frequency', fontsize=12, style='italic', labelpad=10)
    ax.tick_params(axis='x', labelsize=10)
    ax.tick_params(axis='y', labelsize=10)

    for spine in ax.spines.values():
        spine.set_edgecolor('black')
        spine.set_linewidth(0.8)

    ax.set_title(
        "Distribution of Variant Priority Scores",
        fontsize=12,
        weight="bold",
        pad=5,
        loc='center'
    )

    plt.tight_layout()

    # Ensure output directory exists
    os.makedirs(output_dir, exist_ok=True)

    # Save plots in PNG and PDF formats
    fig.savefig(os.path.join(output_dir, "priority_score_histogram.png"), dpi=1200, bbox_inches='tight')
    fig.savefig(os.path.join(output_dir, "priority_score_histogram.pdf"), bbox_inches='tight')
    plt.close()

def plot_top_variants(input_csv, output_dir, top_n=20):
    """Generate a scatter plot for top variants showing combined feature contribution.

    Args:
        input_csv (str): Path to the input CSV file.
        output_dir (str): Directory to save the output plots.
        top_n (int): Number of top variants to display.
    """
    ext = os.path.splitext(input_csv)[1].lower()
    if ext in [".xlsx", ".xls"]:
        df = pd.read_excel(input_csv)
    else:
        df = pd.read_csv(input_csv)
    required_cols = ["Final_Priority_Score", "Normalized_Depth", "Amino_Acid_Impact_Score", "Domain_Position_Match", "Gene"]
    for col in required_cols:
        if col not in df.columns:
            raise ValueError(f"Column '{col}' not found in input file for top variants plot.")
    df_sorted = df.sort_values(by="Final_Priority_Score", ascending=False)
    top_variants = df_sorted.head(top_n)

    vmin = top_variants["Final_Priority_Score"].min()
    vmax = top_variants["Final_Priority_Score"].max()

    sns.set(style="whitegrid", context="talk", font="DejaVu Sans")
    fig, ax = plt.subplots(figsize=(10, 8))

    domain_points = top_variants[top_variants["Domain_Position_Match"] == 1]
    non_domain_points = top_variants[top_variants["Domain_Position_Match"] == 0]

    sc1 = ax.scatter(
        domain_points["Normalized_Depth"],
        domain_points["Amino_Acid_Impact_Score"],
        c=domain_points["Final_Priority_Score"],
        cmap="viridis", vmin=vmin, vmax=vmax,
        s=100, marker="X", edgecolor="black", linewidth=0.5,
        label="Domain Match"
    )

    ax.scatter(
        non_domain_points["Normalized_Depth"],
        non_domain_points["Amino_Acid_Impact_Score"],
        c=non_domain_points["Final_Priority_Score"],
        cmap="plasma", vmin=vmin, vmax=vmax,
        s=100, marker="o", edgecolor="black", linewidth=0.5,
        label="Outside Domain"
    )

    divider = make_axes_locatable(ax)
    cax = divider.append_axes("right", size="2%", pad=0.05)
    cbar = plt.colorbar(sc1, cax=cax)
    cbar.set_label("Final Priority Score", fontsize=12.5, fontstyle="italic")
    cbar.ax.tick_params(labelsize=11.2)

    texts = []
    for i, row in top_variants.iterrows():
        texts.append(
            ax.text(
                row["Normalized_Depth"],
                row["Amino_Acid_Impact_Score"],
                row["Gene"],
                fontsize=10.5, weight="bold", ha='left', va='bottom'
            )
        )
    adjust_text(
        texts,
        expand_points=(2, 2),
        expand_text=(2, 2),
        arrowprops=dict(arrowstyle="-", 
                        color='gray', 
                        lw=0.8,
                        shrinkA=6,  # shrink line at text end to avoid overlap (tune 4-10)
                        shrinkB=2,  # shrink line at point end if needed
                        connectionstyle="arc3,rad=0"  # straight connector; tweak rad for curvature
        ),
        ax=ax
    )

    legend_elements = [
        Line2D([0], [0], marker='X', color='black', label='Domain Match',
                markerfacecolor='black', markersize=8, linestyle='None'),
        Line2D([0], [0], marker='o', color='black', label='Outside Domain',
                markerfacecolor='white', markersize=8, linestyle='None')
    ]

    legend = ax.legend(
        handles=legend_elements,
        title="Domain Position",
        loc="upper right",
        bbox_to_anchor=(1.30, 1.01),
        frameon=True, fontsize=10, title_fontsize=11
    )
    legend.get_frame().set_edgecolor('black')
    legend.get_frame().set_linewidth(0.8)

    ax.set_title(
        "Top Variants Showing Combined Feature Contribution",
        fontsize=13, fontweight="bold", pad=8, loc='center'
    )
    ax.set_xlabel("Normalized Depth", fontsize=14.5, fontstyle="italic")
    ax.set_ylabel("Amino Acid Impact Score", fontsize=14.5, fontstyle="italic")

    ax.tick_params(labelsize=12)
    ax.grid(alpha=0.3)

    for spine in ax.spines.values():
        spine.set_edgecolor('black')
        spine.set_linewidth(0.8)

    fig.tight_layout(rect=[0, 0, 0.9, 1])
    plt.subplots_adjust(top=0.92, bottom=0.08, left=0.1, right=0.90)

    # Ensure output directory exists
    os.makedirs(output_dir, exist_ok=True)

    # Save plots in PNG and PDF formats
    plt.savefig(os.path.join(output_dir, "top_variants_scatter.png"), dpi=1200, bbox_inches='tight')
    plt.savefig(os.path.join(output_dir, "top_variants_scatter.pdf"), bbox_inches='tight')
    plt.close()